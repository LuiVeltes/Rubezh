Вопросы по китайскому контроллеру

- В контроллер можно записать Card, Password, CardRec, Holiday
Card - это карта доступа. А что такое CardRec? Название созвучное с Card, но физический смысл не ясен

- Вопрос не к китайцам. При записи карт использеутся номер(как в mifare), но не используется серия(как в HID). Контроллер не работает с картами HID?

- Добавление карты. Нужно развернутое описание и смысл значений перечислений tagNET_ACCESSCTLCARD_STATE, tagNET_ACCESSCTLCARD_TYPE

- Добавление карты. Структура NET_RECORDSET_ACCESS_CTL_CARD
Что такое nUserTime?
Массив sznDoors заполняется значениями 1 и 2. Что значат эти значения? А если указать не 1 и 2, а 3 и 4?
Что такое szUserID?

- Я добавляю карту
Затем я хочу найти все карты с помощью testRecordSetFindNext_Card
При этом значения структуры tagNET_RECORDSET_ACCESS_CTL_CARD оказываются
stuCreateTime все по нулям. Время у stuValidStartTime и stuValidEndTime по нулям

- Почему при запросе всех карт возвращаются только первые десять

- Для чего служат аргументы структуры поиска карты. Изменение из значений не приводит к изменению результатов поиска

- What's the role of dwRecordMask in structure tagCFG_TIME_SECTION?

- I call void DevConfig_AccessTimeSchedule(LLONG lLoginId)
First bRet is true. But second is always false. Why CLIENT_ParseData return false? I look at the szJsonBuf and stuInfo and it seems valid.

- Есть к тебе несколько вопросов
1. Сколько максимум карт поддерживает контроллер?
2. Сколько максимум паролей контроллер?
3. Нужны ли нам пароли?
4. Есть возможность с помошью SDK сменить IP-адрес. Ходиков Саша(огядываясь на свой опыт) и я считаем, что для этой функции должна быть специальная утилита конфигурирования. Какого твое мнение?
5. Есть мнение минимизировать риски затянуть проект таким образом: выделить первоочередные требования и сосредоточиться на них в ближайшие 3 месяца и второстепенные требования, которые мы будем реализовывать только после того, как будет уверенность в работоспособности первых. Прикинь примерный список.
6. У меня есть функции Открыть дверь, Закрыть дверь, получить статус двери(открыто, закрыть, неизвестно). Как бы я ни открывал/закрывал, статус двери неизменно остается закрытым. Подсоедините к контроллеру что-то реальное, что закрывалось бы и открывалось, чтобы реально менялся статус

- I call
void DevConfig_AccessTimeSchedule(LLONG lLoginId)
what does "nChannel" stands for?

- I notised, that controller can store only four weekly time shedules, one per door. Im i right? If so, then it's a very poor functionality



- I call
void Insert_Card(LLONG lLoginID, int& nRecrdNo)
setting bIsValid = TRUE and
emStatus = NET_ACCESSCTLCARD_STATE_LOSE
has no effect. When i call
BOOL DevCtrl_GetRecordSetInfo(LLONG lLoginID, int nRecordSetType)
on just added card bIsValid is set to FALSE and emStatus is NET_ACCESSCTLCARD_STATE_NORMAL
Alsaw, UserId is always empty, nUserTime is always 0, stuCreateTime is filled with zerros, stuValidStartTime and stuValidEndTime dwHour, dwMinute and dwSecond are zerros too.
Is it right behaviour?

- I set emType to NET_ACCESSCTLCARD_TYPE_GENERAL. Does nUserTime affect anything now? I gues it does only if emType is NET_ACCESSCTLCARD_TYPE_GUEST.

- One more time about SznDoors. I have two doors with two card readers on every door. Four card readers in total. I am adding a card to controller and i want to give access for the first card reader of the first door and for the second card reader on the second door. My sznDoors wheel be 1 and 4. Am i right?

- I don't get usage of CardRec. I want to add, edit and remove cards. Do I need cardRec? What are they for?




A few notes
- Your sad
dwHour?dwMinute?dwSecond of stuValidStartTime and stuValidEndTime are also not supported by BSC
I gues, when adding a card, only hour, minute and second properties of stuValidStartTime and stuValidEndTime does't matter. And year, month and second are steen needed. Correct?

- About CardRec
SDK supports adding, aditing, deleting and searching of CardRecs. Do i realy need all these functions, if i only want to add. remove and edit cards(not card recs)?
When i add a Card, CardRec is adding automaticly? If so. what will happen to Card, if i will delete corresponding CardRec

- IMHO, nCannel is't so good for naming time shedule index, and MAX_DOOR_TIME_SECTION is't good for max time intervals per day. So i was a bit confused

- Functions
BOOL DevCtrl_OpenDoor(LLONG lLoginId)
BOOL DevCtrl_CloseDoor(LLONG lLoginId)
void DevState_DoorStatus(LLONG lLoginId)
have
stuParam.nChannelID = 0;
in their body
What is nChannelID?

- You said that i have to pay no attention to stuCard.szUserID when adding a Card. And what about adding a Password? Should I ignore it too. And is the best value for that szUserID? Null, empty string, "0". After all, what does szUserID for?

- We are using Microsoft .NET Framework technology stack in our development. Your SDK uses C++. So we have to have some wrapper. Mybee you,v already have binding to C#?

- We are planning stress tests on your SDK. Something like writing and deliting large amount of cards. I am not shure about the perfomance and behaviour on connection lost and reconnection logic. If we would't be sattisfied whith SDK, could you give us low-level protocols over tcp-ip or udp(don't know your are using, but i gues one of theese)


//**************************************************

- I call
BOOL DevCtrl_GetLogCount(LLONG lLoginID)
Number of logs is always 2 whatever QUERY_DEVICE_LOG_PARAM fields are. I tried to set stuStartTime and stuEndTime to futire or to the past, I playd with nStartNum, nEndNum and nLogStuType - but I always get 2.
By the way, what is nLogStuType?


- Both
BOOL DevCtrl_GetLogCount(LLONG lLoginID)
and
BOOL Dev_QueryLogList(LLONG lLoginID)
use nStartNum and nEndNum. I gues it acts like a through unique identifier of event log.
But, _DH_DEVICE_LOG_ITEM_EX has no integer field that could take a role of such an identifier.
I alsaw don't see it in in
BOOL CALLBACK MessageCallBack(LONG lCommand, LLONG lLoginID, char *pBuf, DWORD dwBufLen, char *pchDVRIP, LONG nDVRPort, LDWORD dwUser)
So, how should I use nStartNum and nEndNum?


- Functions like Insert_Holiday and Update_Holiday are operation with holidays. But there is no reference to holiday in Card, CarsRec or Password(like they are linked with TimeShedule, for example). It seems like holiday is kind of isolated object. It takes no role in buisness logic on the controller level. Are you using controller as a data storage for holidays data to use in futher time tracking or so?


- One more time about the usage of CardRec (NET_RECORDSET_ACCESS_CTL_CARDREC)
I found only one case, when CardRec can help me
I want to add a NET_RECORDSET_ACCESS_CTL_CARD,
and set stuCard.szPsw
Now, because the card has a password, I have to tell controller the secuence of passing person through the door. Should he pass a card abd then enter his personal password, or vice vera.
This could be done by setting
stuCardRec.emMethod
of NET_RECORDSET_ACCESS_CTL_CARDREC
in Update_CardRec() function.
Im I richt? Should i add a Card and then edit CardRec?


- EventAttach project
section
// access event
else if (DH_ALARM_ACCESS_CTL_EVENT == lCommand)
What is pstuAlarmInfo->szDoorName? How can I set this name?
Does BOOL CALLBACK MessageCallBack(LONG lCommand, LLONG lLoginID, char *pBuf, DWORD dwBufLen, char *pchDVRIP, LONG nDVRPort, LDWORD dwUser)
is a complete example of all possible evens. Or can i recieve event with different lCommand?


- I am using WPF/C#. I subscribed
CLIENT_SetDVRMessCallBack
in my C# code. But sometimes i get "null reference exception" uncathed exception. I'v already found walkaround, but anyway, have you any ideas of what could happen?


- void DevConfig_AccessControl(LLONG lLoginId)
What is nChannel? Door number?


//************************************************************************************

Here's what I want from evnt log monitoring
Steps I want to reproduce in my SDK example
- I successfully connect to the controller
- I subscribe to events
- I pull out ethernet wire
- Wait for a half a minute untill SDK will understand the connection has lost
- Pass a card to card reader few times to generate events
- I plug in ethernet wire
- Do some reconnect logic
- Read all missing logs, occured during connection was lost
- Continue recieving new events
Whell, I gues I know how to reconnect, but I'm not shour I'm right(I'm not shour if i neet to reconect or cleanup before connecting again, and do i neet to subscribe to events again)
But I have no idea about reading missing logs
So, could you please modify EventAttach project to demonstrate steps, described above
It's a very important feature for us. Whitout it we can't process time tracking


- I noticed, that SDK can detect connection lost in about 20 seconds. What is the exact time and how can I modify it


- You sad that SDK can automaticaly reconnect. I use EventAttach project. I set breakpoint to
void CALLBACK HaveReConnectFunc(LLONG lLoginID, char *pchDVRIP, LONG nDVRPort, LDWORD dwUser)
but debugger never steps into it(when I pull out ethernet wire), thow it does in
void CALLBACK DisConnectFunc(LLONG lLoginID, char *pchDVRIP, LONG nDVRPort, LDWORD dwUser)
What am I doung wrong?


MessageCallBack
In your example lCommand can be equal to DH_ALARM_VEHICLE_CONFIRM or DH_ALARM_VEHICLE_LARGE_ANGLE. I don't think my controller can generate such events that contains NET_GPS_STATUS_INFO. Does my controller supports this?

//************************************************************************************

- Thanks alot for new SDK redistributables. Bug with HaveReConnectFunc has gone avay.
No bebugger steps into HaveReConnectFunc
I modified your example like this
void CALLBACK HaveReConnectFunc(LLONG lLoginID, char *pchDVRIP, LONG nDVRPort, LDWORD dwUser)
{
	BOOL bRet = CLIENT_StartListenEx(lLoginID);
}
Without recalling CLIENT_StartListenEx I don't get events any more.
Is it a bug, or a feature? If it's a feature, then why don,t you recall CLIENT_StartListenEx in you original example, which 's main purpose is to demonstrate event log monitorin even after reconnection


I'll descripbe my controller's behaviour
Sutuation one
- I pull out ethernet wire
- DisConnectFunc fired
- I IMMEDIALELY plug in ethernet wire
- DisConnectFunc fired 3-5 times
- HaveReConnectFunc

Sutuation two
- I pull out ethernet wire
- DisConnectFunc fired
- I wait few minutes
- I plug in ethernet wire
- HaveReConnectFunc

The difference between these two cases as you can see is that I get few DisConnectFunc if I don't pause between pulling out  and plugging in again
Is it expected behavior? Does it correlate whit as you said
"etc: Since accounts of BSC is not reusable, BSC do not allow user to reconnect right after disconnected. So reconnection will not be successful until roughly 40 seconds after disconnection."?


After I replaced SDK redistributable dlls, I get error when calling
DevConfig_AccessGeneral,
DevConfig_AccessControl,
DevConfig_AccessTimeSchedule,
Insert_CardRec
testRecordSetFindNext_Card finds no cards
and so on
Maybe I have to update firmware?
The set of thees bugs paralyse my work


Insert_Card
whatever values I set to nDoorNum, sznDoors[], nTimeSectionNum, sznTimeSectionNo[], it always adds 2 doors(1 and 2)


//**************************************************


- I actualy don't like callback from managed C# code to unmanaged code C++ code. I'd prefere polling model, if you don't mind. Here's an idea:
1) We want to monitore controller's event logs
2) Every log has ins own through identifier that increments on every new event log
3) I have stored last identifier, corresponding to last event I get
4) Every time programm starts, I get controller,s last event identifier
5) I compare new last identifier to one, I stored befre
6) If new last identifier if greater the the stored one, then I read missing event logs with identifier graeter then stored one and less or equal then new one
7) Do steps 4-6 in the infinite loop
I have an experience in driver development(like you SDK) and I used described scheme in practice many times with many devices.
Can you provide me an example, that works like this?
I'm afraid I'm confused with the limitation of SDK, and the tip mentiond in the last answer does't make me happy. I'v already have problem with callback to my C# code. Now I have a C++ DLL, that incapsulates all callback and reconnection logic and a C# project that polls this C++ DLL for new events. I don't think it's a best practice - it's a worst workaround. So I hope to improve my mazy code with polling model


- Do you have Web service to SDK or somethig?


- You said
"sznDoors and sznTimeSectionNo are connected params. nDoorNum and nTimeSectionNum should be equal"
Imagine I have a controller with 4 card readers and 100 TimeShedules
I want give a person a card, that can pass through first and second door withit 10-20 TimeShedules
My code will be like this
stuCard.nDoorNum = 2;
stuCard.sznDoors[0] = 1;
stuCard.sznDoors[1] = 2;
stuCard.nTimeSectionNum = 11;
stuCard.sznTimeSectionNo[0] = 10;
stuCard.sznTimeSectionNo[1] = 11;
stuCard.sznTimeSectionNo[2] = 12;
stuCard.sznTimeSectionNo[3] = 13;
stuCard.sznTimeSectionNo[4] = 14;
stuCard.sznTimeSectionNo[5] = 15;
stuCard.sznTimeSectionNo[6] = 16;
stuCard.sznTimeSectionNo[7] = 17;
stuCard.sznTimeSectionNo[8] = 18;
stuCard.sznTimeSectionNo[9] = 19;
stuCard.sznTimeSectionNo[10] = 20;
As you can see, doors and time sections are not equal
Or I don't understand the meaning of NET_RECORDSET_ACCESS_CTL_CARD structire again?


- JianJun, don't forget to answer