<UserControl x:Class="DevicesModule.Views.DevicesView" xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation" xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml" xmlns:Controls="clr-namespace:Controls;assembly=Controls" xmlns:Converters="clr-namespace:DevicesModule.Converters" xmlns:Views="clr-namespace:DevicesModule.Views" Focusable="True">

	<UserControl.Resources>
		<ContextMenu x:Key="DeviceContextMenu">
			<MenuItem Command="{Binding CopyCommand}" Header="Копировать (Ctrl+C)" />
            <MenuItem Command="{Binding CutCommand}" Header="Вырезать (Ctrl+X)" />
            <MenuItem Command="{Binding PasteCommand}" Header="Вставить (Ctrl+V)" />
			<MenuItem Command="{Binding PasteAsCommand}" Header="Вставить как" />
			<Separator />
            <MenuItem Command="{Binding AddCommand}" Header="Добавить дочернее устройство (Ctrl+N)" />
            <MenuItem Command="{Binding AddToParentCommand}" Header="Добавить к родительскому устройству (Ctrl+M)" />
            <MenuItem Command="{Binding RemoveCommand}" Header="Удалить (Ctrl+Del)" />
			<MenuItem Command="{Binding ShowZoneLogicCommand}" Header="Настройка логики исполнительного устройства по состоянию зон" />
			<MenuItem Command="{Binding ShowPropertiesCommand}" Header="Свойства" />
		</ContextMenu>
		<Converters:InverseBooleanConverter x:Key="InverseBooleanConverter" />
	</UserControl.Resources>

	<Grid>
		<Grid.RowDefinitions>
			<RowDefinition Height="*" MinHeight="200" />
			<RowDefinition Height="Auto" />
			<RowDefinition Height="150" MinHeight="150" />
		</Grid.RowDefinitions>
		<Grid Grid.Row="0">
            <Controls:TreeListView Focusable="True" ItemsSource="{Binding RootDevices}" SelectedObject="{Binding SelectedDevice}">
				<Controls:TreeListView.Resources>
					<Style x:Key="{x:Type ComboBox}" BasedOn="{StaticResource {x:Type ComboBox}}" TargetType="ComboBox">
						<Setter Property="MinWidth" Value="0" />
						<Setter Property="MinHeight" Value="0" />
					</Style>
					<Style x:Key="{x:Type TextBox}" BasedOn="{StaticResource {x:Type TextBox}}" TargetType="TextBox">
						<Setter Property="MinWidth" Value="0" />
						<Setter Property="MinHeight" Value="0" />
					</Style>
				</Controls:TreeListView.Resources>
				<Controls:TreeListView.Columns>
					<GridViewColumn Width="250" Header="Устройство">
						<GridViewColumn.CellTemplate>
							<DataTemplate>
								<Controls:EditorPresenter>
									<Controls:EditorPresenter.ViewTemplate>
										<ControlTemplate>
											<StackPanel Background="Transparent" ContextMenu="{StaticResource DeviceContextMenu}" Orientation="Horizontal">
												<CheckBox IsChecked="{Binding IsUsed, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}" Visibility="{Binding Device.CanBeNotUsed, Converter={StaticResource BoolToVisibilityConverter}}" />
												<Image Width="16" Height="16" Margin="5, 0, 5, 0" Source="{Binding Driver.ImageSource}" />
												<TextBlock HorizontalAlignment="Stretch" VerticalAlignment="Center" Text="{Binding Driver.ShortName}" />
											</StackPanel>
										</ControlTemplate>
									</Controls:EditorPresenter.ViewTemplate>
									<Controls:EditorPresenter.EditTemplate>
										<ControlTemplate>
											<DockPanel ContextMenu="{StaticResource DeviceContextMenu}">
												<StackPanel DockPanel.Dock="Left" Orientation="Horizontal">
													<CheckBox IsChecked="{Binding IsUsed, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}" Visibility="{Binding Device.CanBeNotUsed, Converter={StaticResource BoolToVisibilityConverter}}" />
													<Image Width="16" Height="16" Margin="5, 0, 5, 0" Source="{Binding Driver.ImageSource}" />
													<TextBlock VerticalAlignment="Center" Text="{Binding Driver.ShortName}" Visibility="{Binding CanChangeDriver, Converter={StaticResource BoolToVisibilityConverter}, ConverterParameter=True}" />
												</StackPanel>
												<ComboBox ItemsSource="{Binding AvailvableDrivers}" SelectedItem="{Binding Driver, UpdateSourceTrigger=PropertyChanged}" Visibility="{Binding CanChangeDriver, Converter={StaticResource BoolToVisibilityConverter}}">
													<ComboBox.ItemTemplate>
														<DataTemplate>
															<TextBlock Foreground="Black" Text="{Binding ShortName}" />
														</DataTemplate>
													</ComboBox.ItemTemplate>
												</ComboBox>
											</DockPanel>
										</ControlTemplate>
									</Controls:EditorPresenter.EditTemplate>
								</Controls:EditorPresenter>
							</DataTemplate>
						</GridViewColumn.CellTemplate>
					</GridViewColumn>
					<GridViewColumn Width="100" Header="Адрес">
						<GridViewColumn.CellTemplate>
							<DataTemplate>
								<Controls:EditorPresenter>
									<Controls:EditorPresenter.ViewTemplate>
										<ControlTemplate>
											<TextBlock Text="{Binding Address}" Visibility="{Binding Driver.HasAddress, Converter={StaticResource BoolToVisibilityConverter}}" />
										</ControlTemplate>
									</Controls:EditorPresenter.ViewTemplate>
									<Controls:EditorPresenter.EditTemplate>
										<ControlTemplate>
											<Grid>
												<Views:AddressEditor Address="{Binding Address}" Device="{Binding Device}" Visibility="{Binding Device.CanEditAddress, Converter={StaticResource BoolToVisibilityConverter}}" />
												<TextBlock Text="{Binding Address}" Visibility="{Binding Device.CanEditAddress, Converter={StaticResource BoolToVisibilityConverter}, ConverterParameter=True}" />
											</Grid>
										</ControlTemplate>
									</Controls:EditorPresenter.EditTemplate>
								</Controls:EditorPresenter>
							</DataTemplate>
						</GridViewColumn.CellTemplate>
					</GridViewColumn>

                    <GridViewColumn Width="100" Header="Зона">
                        <GridViewColumn.CellTemplate>
                            <DataTemplate>
                                <StackPanel Orientation="Horizontal">
                                    <Image Width="14" Height="14" Margin="0, 0 ,5, 0" Source="/Controls;component/Images/Link.png" Visibility="{Binding HasExternalDevices, Converter={StaticResource BoolToVisibilityConverter}}" />
                                    <TextBlock Text="{Binding EditingPresentationZone}" ToolTip="{Binding EditingPresentationZone}" MinWidth="100" Cursor="Hand"
                                            Visibility="{Binding IsZoneOrLogic, Converter={StaticResource BoolToVisibilityConverter}}">
                                        <TextBlock.InputBindings>
                                            <MouseBinding MouseAction="LeftClick" Command="{Binding ShowZoneOrLogicCommand}" />
                                        </TextBlock.InputBindings>
                                    </TextBlock>
                                </StackPanel>
                            </DataTemplate>
                        </GridViewColumn.CellTemplate>
                    </GridViewColumn>
                    
					<GridViewColumn Header="Примечание">
						<GridViewColumn.CellTemplate>
							<DataTemplate>
								<Controls:EditorPresenter>
									<Controls:EditorPresenter.ViewTemplate>
										<ControlTemplate>
											<TextBlock Text="{Binding Description}" />
										</ControlTemplate>
									</Controls:EditorPresenter.ViewTemplate>
									<Controls:EditorPresenter.EditTemplate>
										<ControlTemplate>
											<TextBox Name="descriptionTextBox" HorizontalAlignment="Stretch" BorderThickness="0" Foreground="Black" Text="{Binding Description, UpdateSourceTrigger=PropertyChanged}" />
											<ControlTemplate.Triggers>
												<Trigger SourceName="descriptionTextBox" Property="IsVisible" Value="True">
													<Setter TargetName="descriptionTextBox" Property="FocusManager.FocusedElement" Value="{Binding ElementName=descriptionTextBox}" />
												</Trigger>
											</ControlTemplate.Triggers>
										</ControlTemplate>
									</Controls:EditorPresenter.EditTemplate>
								</Controls:EditorPresenter>
							</DataTemplate>
						</GridViewColumn.CellTemplate>
					</GridViewColumn>
				</Controls:TreeListView.Columns>
			</Controls:TreeListView>
			<!--
				<DataGrid Name="_devicesDataGrid" Focusable="True" ItemsSource="{Binding Devices}" SelectedItem="{Binding SelectedDevice}" IsReadOnly="False"
				VirtualizingStackPanel.IsVirtualizing="False">
				<DataGrid.Columns>
				<DataGridTemplateColumn Header="Устройство" Width="250">
				<DataGridTemplateColumn.CellTemplate>
				<DataTemplate>
				<StackPanel Orientation="Horizontal" Margin="{Binding Level, Converter={StaticResource LevelToMarginConverter}}"
				ContextMenu="{StaticResource DeviceContextMenu}">
				<CheckBox Name="checkBoxExpand"  Style="{StaticResource TreeExpanderStyle}" IsChecked="{Binding IsExpanded, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}"
				Visibility="{Binding HasChildren, Converter={StaticResource BoolToVisibilityConverter}}" />
				<CheckBox IsChecked="{Binding IsUsed, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}"
				Visibility="{Binding Device.CanBeNotUsed, Converter={StaticResource BoolToVisibilityConverter}}" />
				<Image Source="{Binding Driver.ImageSource}" Width="16" Height="16" Margin="5, 0, 5, 0" />
				<TextBlock Text="{Binding Driver.ShortName}" HorizontalAlignment="Stretch" Width="200" />
				</StackPanel>
				</DataTemplate>
				</DataGridTemplateColumn.CellTemplate>
				<DataGridTemplateColumn.CellEditingTemplate>
				<DataTemplate>
				<StackPanel Orientation="Horizontal" Margin="{Binding Level, Converter={StaticResource LevelToMarginConverter}}"
				ContextMenu="{StaticResource DeviceContextMenu}">
				<CheckBox Style="{StaticResource TreeExpanderStyle}" IsChecked="{Binding IsExpanded, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}"
				Visibility="{Binding HasChildren, Converter={StaticResource BoolToVisibilityConverter}}" />
				<CheckBox IsChecked="{Binding IsUsed, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}"
				Visibility="{Binding Device.CanBeNotUsed, Converter={StaticResource BoolToVisibilityConverter}}" />
				<Image Source="{Binding Driver.ImageSource}" Width="16" Height="16" Margin="5, 0, 5, 0" />
				<TextBlock Text="{Binding Driver.ShortName}"
				Visibility="{Binding CanChangeDriver, Converter={StaticResource BoolToVisibilityConverter}, ConverterParameter=True}" />
				<ComboBox ItemsSource="{Binding AvailvableDrivers}" SelectedItem="{Binding Driver, UpdateSourceTrigger=PropertyChanged}"
				Visibility="{Binding CanChangeDriver, Converter={StaticResource BoolToVisibilityConverter}}">
				<ComboBox.ItemTemplate>
				<DataTemplate>
				<TextBlock Text="{Binding ShortName}" Foreground="Black" />
				</DataTemplate>
				</ComboBox.ItemTemplate>
				</ComboBox>
				</StackPanel>
				</DataTemplate>
				</DataGridTemplateColumn.CellEditingTemplate>
				</DataGridTemplateColumn>
				
				<DataGridTemplateColumn Header="Адрес" Width="100">
				<DataGridTemplateColumn.CellTemplate>
				<DataTemplate>
				<TextBlock Text="{Binding Address}" Visibility="{Binding Driver.HasAddress, Converter={StaticResource BoolToVisibilityConverter}}" />
				</DataTemplate>
				</DataGridTemplateColumn.CellTemplate>
				<DataGridTemplateColumn.CellEditingTemplate>
				<DataTemplate>
				<StackPanel>
				<Views:AddressEditor Visibility="{Binding Device.CanEditAddress, Converter={StaticResource BoolToVisibilityConverter}}"
				Address="{Binding Address}" Device="{Binding Device}" />
				<TextBlock Text="{Binding Address}" />
				</StackPanel>
				</DataTemplate>
				</DataGridTemplateColumn.CellEditingTemplate>
				</DataGridTemplateColumn>
				
				<DataGridTemplateColumn Header="Зона" Width="100">
				<DataGridTemplateColumn.CellTemplate>
				<DataTemplate>
				<StackPanel Orientation="Horizontal">
				<Image Source="/Controls;component/Images/Link.png" Width="14" Height="14" Margin="0, 0 ,5, 0"
				Visibility="{Binding HasExternalDevices, Converter={StaticResource BoolToVisibilityConverter}}" />
				<TextBlock Text="{Binding PresentationZone}" ToolTip="{Binding PresentationZone}" />
				</StackPanel>
				</DataTemplate>
				</DataGridTemplateColumn.CellTemplate>
				<DataGridTemplateColumn.CellEditingTemplate>
				<DataTemplate>
				<Grid>
				<ComboBox ItemsSource="{Binding Zones}" SelectedItem="{Binding Zone, UpdateSourceTrigger=PropertyChanged}" VerticalAlignment="Stretch" VerticalContentAlignment="Stretch" Height="19"
				Visibility="{Binding IsZoneDevice, Converter={StaticResource BoolToVisibilityConverter}}">
				<ComboBox.ItemTemplate>
				<DataTemplate>
				<TextBlock Text="{Binding PresentationName}" VerticalAlignment="Stretch" Foreground="Black" />
				</DataTemplate>
				</ComboBox.ItemTemplate>
				</ComboBox>
				<TextBlock Text="{Binding PresentationZone}" Visibility="{Binding Driver.IsZoneLogicDevice, Converter={StaticResource BoolToVisibilityConverter}}">
				<TextBlock.InputBindings>
				<MouseBinding MouseAction="LeftDoubleClick" Command="{Binding ShowZoneLogicCommand}" />
				</TextBlock.InputBindings>
				</TextBlock>
				</Grid>
				</DataTemplate>
				</DataGridTemplateColumn.CellEditingTemplate>
				</DataGridTemplateColumn>
				
				<DataGridTemplateColumn Header="Примечание" Width="*">
				<DataGridTemplateColumn.CellTemplate>
				<DataTemplate>
				<TextBlock Text="{Binding Description}" />
				</DataTemplate>
				</DataGridTemplateColumn.CellTemplate>
				<DataGridTemplateColumn.CellEditingTemplate>
				<DataTemplate>
				<TextBox Name="descriptionTextBox" Text="{Binding Description}" BorderThickness="0" Foreground="Black" HorizontalAlignment="Stretch" />
				<DataTemplate.Triggers>
				<Trigger SourceName="descriptionTextBox" Property="IsVisible" Value="True">
				<Setter TargetName="descriptionTextBox" Property="FocusManager.FocusedElement" Value="{Binding ElementName=descriptionTextBox}"/>
				</Trigger>
				</DataTemplate.Triggers>
				</DataTemplate>
				</DataGridTemplateColumn.CellEditingTemplate>
				</DataGridTemplateColumn>
				</DataGrid.Columns>
				</DataGrid>
			-->
		</Grid>
		<GridSplitter Grid.Row="1" Height="5" HorizontalAlignment="Stretch" VerticalAlignment="Stretch" Background="Transparent" Cursor="SizeNS" />

		<Grid Grid.Row="2" Margin="0, 5, 0, 0" DataContext="{Binding SelectedDevice}">
			<Grid>
				<Grid.ColumnDefinitions>
					<ColumnDefinition Width="*" />
					<ColumnDefinition Width="40" />
				</Grid.ColumnDefinitions>
				<Border Grid.Column="0" Background="{DynamicResource BackgroundBrush}" CornerRadius="5,0,0,5">
					<Grid>
						<Views:PropertiesView Visibility="{Binding PropertiesViewModel.ParameterVis, Converter={StaticResource BoolToVisibilityConverter}, ConverterParameter=true}" />
						<Views:ParametersView DataContext="{Binding PropertiesViewModel}" Visibility="{Binding ParameterVis, Converter={StaticResource BoolToVisibilityConverter}}" />
					</Grid>
				</Border>
				<Border Grid.Column="1" Background="{DynamicResource BackgroundBrush}" CornerRadius="0,5,5,0">
					<StackPanel DataContext="{Binding PropertiesViewModel}">
						<Controls:ToggleButton Command="{Binding PropVisCommand}" ImageSource="/Controls;component/Images/devparameters.png" IsChecked="{Binding ParameterVis, Converter={StaticResource InverseBooleanConverter}}" ToolTip="Информация об устройстве" Visibility="{Binding Choise, Converter={StaticResource BoolToVisibilityConverter}}" />
                        <Controls:ToggleButton Command="{Binding ParamVisCommand}" ImageSource="/Controls;component/Images/adrparameters.png" IsChecked="{Binding ParameterVis}" ToolTip="Параметры устройства" Visibility="{Binding Choise, Converter={StaticResource BoolToVisibilityConverter}}" />
                        <StackPanel Visibility="{Binding ParameterVis, Converter={StaticResource BoolToVisibilityConverter}}" IsEnabled="{Binding IsAuParametersReady}">
							<Controls:ToolBarButton Width="36" Height="36" Margin="0,0,0,-8" Command="{Binding Context.DeviceCommandsViewModel.GetConfigurationParametersCommand}" ImageSource="/Controls;component/Images/readconfig.png" ToolTip="Считать параметры устройства" Visibility="{Binding Device.Driver.HasConfigurationProperties, Converter={StaticResource BoolToVisibilityConverter}}" />
							<Controls:ToolBarButton Width="36" Height="36" Margin="0,0,0,-8" Command="{Binding Context.DeviceCommandsViewModel.SetConfigurationParametersCommand}" ImageSource="/Controls;component/Images/writeconfig.png" ToolTip="Записать параметры на устройство" Visibility="{Binding Device.Driver.HasConfigurationProperties, Converter={StaticResource BoolToVisibilityConverter}}" />
							<Controls:ToolBarButton Width="36" Height="36" Command="{Binding Context.DeviceCommandsViewModel.ResetConfigurationParametersCommand}" ImageSource="/Controls;component/Images/defconfig.png" ToolTip="Параметры по умолчанию" Visibility="{Binding Device.Driver.HasConfigurationProperties, Converter={StaticResource BoolToVisibilityConverter}}" />
						</StackPanel>
					</StackPanel>
				</Border>
			</Grid>
		</Grid>
	</Grid>
</UserControl>