<UserControl x:Class="DiagnosticsModule.Views.DevicesTreeView" xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation" xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml" xmlns:c="clr-namespace:Controls;assembly=Controls" MinWidth="600" MinHeight="600" xmlns:Views="clr-namespace:DevicesModule.Views;assembly=DevicesModule">

	<UserControl.Resources>
		<ContextMenu x:Key="DeviceContextMenu">
			<MenuItem Command="{Binding CopyCommand}" Header="Копировать" />
			<MenuItem Command="{Binding CutCommand}" Header="Вырезать" />
			<MenuItem Command="{Binding PasteCommand}" Header="Вставить" />
			<MenuItem Command="{Binding PasteAsCommand}" Header="Вставить как" />
			<Separator />
			<MenuItem Command="{Binding AddCommand}" Header="Добавить" />
			<MenuItem Command="{Binding AddManyCommand}" Header="Добавить несколько" />
			<MenuItem Command="{Binding RemoveCommand}" Header="Удалить" />
			<MenuItem Command="{Binding ShowZoneLogicCommand}" Header="Настройка логики" Visibility="{Binding Driver.IsZoneLogicDevice, Converter={StaticResource BoolToVisibilityConverter}}" />
			<MenuItem Command="{Binding ShowPropertiesCommand}" Header="Свойства" />
		</ContextMenu>

		<HierarchicalDataTemplate x:Key="dt" ItemsSource="{Binding Children}" />

		<Style x:Key="GridBlockStyle" TargetType="{x:Type FrameworkElement}">
			<Setter Property="VerticalAlignment" Value="Center" />
			<Setter Property="Visibility" Value="{Binding Path=IsSelected, RelativeSource={RelativeSource FindAncestor, AncestorType={x:Type c:TreeListViewItem}}, Converter={StaticResource BoolToVisibilityConverter}, ConverterParameter=True}" />
		</Style>

		<Style x:Key="GridEditStyle" TargetType="{x:Type FrameworkElement}">
			<Setter Property="VerticalAlignment" Value="Center" />
			<Setter Property="Visibility" Value="{Binding Path=IsSelected, RelativeSource={RelativeSource FindAncestor, AncestorType={x:Type c:TreeListViewItem}}, Converter={StaticResource BoolToVisibilityConverter}}" />
		</Style>
	</UserControl.Resources>

	<Grid>
		<Grid.RowDefinitions>
			<RowDefinition Height="Auto" />
			<RowDefinition Height="*" />
		</Grid.RowDefinitions>

		<c:TreeListView Grid.Row="1" ItemsSource="{Binding Devices}" ItemTemplate="{StaticResource dt}">
			<c:TreeListView.Resources>
				<Style BasedOn="{StaticResource {x:Type c:TreeListViewItem}}" TargetType="{x:Type c:TreeListViewItem}">
					<Setter Property="IsExpanded" Value="{Binding IsExpanded}" />
				</Style>
			</c:TreeListView.Resources>
			<c:TreeListView.Columns>
				<GridViewColumn Width="250" Header="Устройство">
					<GridViewColumn.CellTemplate>
						<DataTemplate>
							<Grid>
								<StackPanel ContextMenu="{StaticResource DeviceContextMenu}" Orientation="Horizontal" Style="{StaticResource GridBlockStyle}">
									<CheckBox IsChecked="{Binding IsUsed, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}" Visibility="{Binding Device.CanBeNotUsed, Converter={StaticResource BoolToVisibilityConverter}}" />
									<Image Width="16" Height="16" Margin="5, 0, 5, 0" Source="{Binding Driver.ImageSource}" />
									<TextBlock Width="200" HorizontalAlignment="Stretch" Text="{Binding Driver.ShortName}" VerticalAlignment="Center" />
								</StackPanel>

								<StackPanel ContextMenu="{StaticResource DeviceContextMenu}" Orientation="Horizontal" Style="{StaticResource GridEditStyle}">
									<CheckBox IsChecked="{Binding IsUsed, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}" Visibility="{Binding Device.CanBeNotUsed, Converter={StaticResource BoolToVisibilityConverter}}" />
									<Image Width="16" Height="16" Margin="5, 0, 5, 0" Source="{Binding Driver.ImageSource}" />
									<TextBlock Text="{Binding Driver.ShortName}" Visibility="{Binding CanChangeDriver, Converter={StaticResource BoolToVisibilityConverter}, ConverterParameter=True}" />
									<ComboBox ItemsSource="{Binding AvailvableDrivers}" SelectedItem="{Binding Driver, UpdateSourceTrigger=PropertyChanged}" Visibility="{Binding CanChangeDriver, Converter={StaticResource BoolToVisibilityConverter}}">
										<ComboBox.ItemTemplate>
											<DataTemplate>
												<TextBlock Foreground="Black" Text="{Binding ShortName}" />
											</DataTemplate>
										</ComboBox.ItemTemplate>
									</ComboBox>
								</StackPanel>
							</Grid>
						</DataTemplate>
					</GridViewColumn.CellTemplate>
				</GridViewColumn>
				<GridViewColumn Width="100" Header="Адрес">
					<GridViewColumn.CellTemplate>
						<DataTemplate>
							<Grid>
								<TextBlock Style="{StaticResource GridBlockStyle}" Text="{Binding Address}" Visibility="{Binding Driver.HasAddress, Converter={StaticResource BoolToVisibilityConverter}}" />
								<StackPanel Style="{StaticResource GridEditStyle}">
									<Views:AddressEditor Visibility="{Binding Device.CanEditAddress, Converter={StaticResource BoolToVisibilityConverter}}" Address="{Binding Address}" Device="{Binding Device}" />
									<TextBlock Text="{Binding Address}" Visibility="{Binding Device.CanEditAddress, Converter={StaticResource BoolToVisibilityConverter}, ConverterParameter=True}"/>
								</StackPanel>
							</Grid>
						</DataTemplate>
					</GridViewColumn.CellTemplate>
				</GridViewColumn>
				<GridViewColumn Width="100" Header="Зона">
					<GridViewColumn.CellTemplate>
						<DataTemplate>
							<Grid>
								<StackPanel Orientation="Horizontal" Style="{StaticResource GridBlockStyle}">
									<Image Source="/Controls;component/Images/Link.png" Width="14" Height="14" Margin="0, 0 ,5, 0" Visibility="{Binding HasExternalDevices, Converter={StaticResource BoolToVisibilityConverter}}" />
									<TextBlock Text="{Binding PresentationZone}" ToolTip="{Binding PresentationZone}" />
								</StackPanel>
								<Grid Style="{StaticResource GridEditStyle}">
									<ComboBox ItemsSource="{Binding Zones}" SelectedItem="{Binding Zone, UpdateSourceTrigger=PropertyChanged}" VerticalAlignment="Stretch" VerticalContentAlignment="Stretch" Height="19" Visibility="{Binding IsZoneDevice, Converter={StaticResource BoolToVisibilityConverter}}">
										<ComboBox.ItemTemplate>
											<DataTemplate>
												<TextBlock Text="{Binding PresentationName}" VerticalAlignment="Stretch" Foreground="Black" />
											</DataTemplate>
										</ComboBox.ItemTemplate>
									</ComboBox>
									<TextBlock Text="{Binding PresentationZone}" Visibility="{Binding Driver.IsZoneLogicDevice, Converter={StaticResource BoolToVisibilityConverter}}">
                                        <TextBlock.InputBindings>
                                            <MouseBinding MouseAction="LeftDoubleClick" Command="{Binding ShowZoneLogicCommand}" />
                                        </TextBlock.InputBindings>
									</TextBlock>
								</Grid>
							</Grid>
						</DataTemplate>
					</GridViewColumn.CellTemplate>
				</GridViewColumn>
				<GridViewColumn Header="Примечание">
					<GridViewColumn.CellTemplate>
						<DataTemplate>
							<Grid Style="{StaticResource GridEditStyle}">
								<TextBlock Text="{Binding Description}" Style="{StaticResource GridBlockStyle}" />
								<TextBox Name="descriptionTextBox" Text="{Binding Description}" BorderThickness="0" Foreground="Black" HorizontalAlignment="Stretch" />
							</Grid>
						</DataTemplate>
					</GridViewColumn.CellTemplate>
				</GridViewColumn>
			</c:TreeListView.Columns>
		</c:TreeListView>
	</Grid>
</UserControl>