<UserControl x:Class="GKModule.Views.DevicesView"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:Controls="clr-namespace:Controls;assembly=Controls"
             xmlns:Converters="clr-namespace:GKModule.Converters"
             xmlns:drag="clr-namespace:Infrastructure.Common.Services.DragDrop;assembly=Infrastructure.Common"
             xmlns:Views="clr-namespace:GKModule.Views">

	<UserControl.Resources>
		<ContextMenu x:Key="DeviceContextMenu">
			<MenuItem Command="{Binding CopyCommand}" Header="Копировать (Ctrl+C)" />
			<MenuItem Command="{Binding CutCommand}" Header="Вырезать (Ctrl+X)" />
			<MenuItem Command="{Binding PasteCommand}" Header="Вставить (Ctrl+V)" />
			<Separator />
			<MenuItem Command="{Binding AddCommand}" Header="Добавить дочернее устройство (Ctrl+N)" />
			<MenuItem Command="{Binding AddToParentCommand}" Header="Добавить к родительскому устройству (Ctrl+M)" />
			<MenuItem Command="{Binding RemoveCommand}" Header="Удалить (Ctrl+Del)" />
			<MenuItem Command="{Binding ShowLogicCommand}" Header="Настройка логики исполнительного устройства по состоянию зон" />
			<MenuItem Command="{Binding ShowPropertiesCommand}" Header="Свойства" />
		</ContextMenu>
		<Converters:InverseBooleanConverter x:Key="InverseBooleanConverter" />
	</UserControl.Resources>

	<Grid>
		<Grid.RowDefinitions>
			<RowDefinition Height="*" MinHeight="200" />
			<RowDefinition Height="Auto" />
			<RowDefinition Height="150" MinHeight="150" />
		</Grid.RowDefinitions>
		<Controls:TreeListView Grid.Row="0" Focusable="True" ItemsSource="{Binding RootDevices}" SelectedObject="{Binding SelectedDevice}" VirtualizingStackPanel.IsVirtualizing="True" VirtualizingStackPanel.VirtualizationMode="Recycling">
			<Controls:TreeListView.Columns>
				<GridViewColumn Width="250" Header="Устройство">
					<GridViewColumn.CellTemplate>
						<DataTemplate>
							<Controls:EditorPresenter>
								<Controls:EditorPresenter.ViewTemplate>
									<ControlTemplate>
										<StackPanel ContextMenu="{StaticResource DeviceContextMenu}" Orientation="Horizontal">
											<CheckBox IsChecked="{Binding IsUsed, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}" Visibility="{Binding Device.CanBeNotUsed, Converter={StaticResource BoolToVisibilityConverter}}" />
											<StackPanel Orientation="Horizontal">
												<Image Source="/Controls;component/Images/map1.png" Visibility="{Binding Path=Driver.IsPlaceable, Converter={StaticResource BoolToVisibilityConverter}, ConverterParameter=true}" />
												<drag:DragDropDecorator Cursor="Hand" DragCommand="{Binding CreateDragObjectCommand}" DragVisualProvider="{Binding CreateDragVisual}" IsSource="True">
													<drag:DragDropDecorator.InputBindings>
														<MouseBinding Command="{Binding ShowOnPlanCommand}" MouseAction="LeftClick" />
													</drag:DragDropDecorator.InputBindings>
													<Grid Visibility="{Binding Path=Driver.IsPlaceable, Converter={StaticResource BoolToVisibilityConverter}}">
														<Image Source="/Controls;component/Images/map3.png" Visibility="{Binding IsOnPlan, Converter={StaticResource BoolToVisibilityConverter}}" />
														<Image Source="/Controls;component/Images/map2.png" Visibility="{Binding IsOnPlan, Converter={StaticResource BoolToVisibilityConverter}, ConverterParameter=true}" />
													</Grid>
												</drag:DragDropDecorator>
											</StackPanel>
                                            <Image Source="{Binding Driver.ImageSource}" Width="16" Height="16" Margin="5, 0, 5, 0" />
                                            <TextBlock Text="{Binding Device.ShortName}" Width="200" HorizontalAlignment="Stretch" VerticalAlignment="Center">
												<TextBlock.Style>
													<Style>
														<Style.Triggers>
															<DataTrigger Binding="{Binding Device.Driver.IsPlaceable}" Value="True">
																<DataTrigger.Setters>
																	<Setter Property="TextBlock.FontWeight" Value="Bold" />
																</DataTrigger.Setters>
															</DataTrigger>
														</Style.Triggers>
													</Style>
												</TextBlock.Style>
											</TextBlock>
										</StackPanel>
									</ControlTemplate>
								</Controls:EditorPresenter.ViewTemplate>
								<Controls:EditorPresenter.EditTemplate>
									<ControlTemplate>
										<DockPanel ContextMenu="{StaticResource DeviceContextMenu}">
											<StackPanel DockPanel.Dock="Left" Orientation="Horizontal">
												<CheckBox IsChecked="{Binding IsUsed, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}" Visibility="{Binding Device.CanBeNotUsed, Converter={StaticResource BoolToVisibilityConverter}}" />
												<Image Source="/Controls;component/Images/map1.png" Visibility="{Binding Path=Driver.IsPlaceable, Converter={StaticResource BoolToVisibilityConverter}, ConverterParameter=true}" />
												<Grid Visibility="{Binding Path=Driver.IsPlaceable, Converter={StaticResource BoolToVisibilityConverter}}">
													<Image Source="/Controls;component/Images/map3.png" Visibility="{Binding IsOnPlan, Converter={StaticResource BoolToVisibilityConverter}}" />
													<Image Source="/Controls;component/Images/map2.png" Visibility="{Binding IsOnPlan, Converter={StaticResource BoolToVisibilityConverter}, ConverterParameter=true}" />
												</Grid>
                                                <Image Width="16" Height="16" Margin="5, 0, 5, 0" Source="{Binding Driver.ImageSource}" Visibility="{Binding CanChangeDriver, Converter={StaticResource BoolToVisibilityConverter}, ConverterParameter=True}" />
                                                <TextBlock VerticalAlignment="Center" Text="{Binding Device.ShortName}" Visibility="{Binding CanChangeDriver, Converter={StaticResource BoolToVisibilityConverter}, ConverterParameter=True}" />
											</StackPanel>
											<ComboBox ItemsSource="{Binding AvailvableDrivers}" SelectedItem="{Binding Driver, UpdateSourceTrigger=PropertyChanged}" Visibility="{Binding CanChangeDriver, Converter={StaticResource BoolToVisibilityConverter}}">
												<ComboBox.ItemTemplate>
													<DataTemplate>
                                                        <Grid>
                                                            <Image Source="{Binding ImageSource}" Width="16" Height="16" HorizontalAlignment="Left" VerticalAlignment="Center" Margin="5, 0, 5, 0" />
                                                            <TextBlock Text="{Binding ShortName}" HorizontalAlignment="Stretch" VerticalAlignment="Center" Foreground="Black" Margin="31 0 0 0" />
                                                        </Grid>
													</DataTemplate>
												</ComboBox.ItemTemplate>
											</ComboBox>
                                        </DockPanel>
									</ControlTemplate>
								</Controls:EditorPresenter.EditTemplate>
							</Controls:EditorPresenter>
						</DataTemplate>
					</GridViewColumn.CellTemplate>
				</GridViewColumn>

				<GridViewColumn Width="100" Header="Адрес">
					<GridViewColumn.CellTemplate>
						<DataTemplate>
							<Controls:EditorPresenter>
								<Controls:EditorPresenter.ViewTemplate>
									<ControlTemplate>
										<TextBlock Text="{Binding PresentationAddress}" />
									</ControlTemplate>
								</Controls:EditorPresenter.ViewTemplate>
								<Controls:EditorPresenter.EditTemplate>
									<ControlTemplate>
										<Grid>
											<Views:AddressEditor Address="{Binding Address}" Device="{Binding Device}" Visibility="{Binding Device.CanEditAddress, Converter={StaticResource BoolToVisibilityConverter}}" />
											<TextBlock Text="{Binding Address}" Visibility="{Binding Device.CanEditAddress, Converter={StaticResource BoolToVisibilityConverter}, ConverterParameter=True}" />
										</Grid>
									</ControlTemplate>
								</Controls:EditorPresenter.EditTemplate>
							</Controls:EditorPresenter>
						</DataTemplate>
					</GridViewColumn.CellTemplate>
				</GridViewColumn>

				<GridViewColumn Header="Зона или Логика" Width="300">
					<GridViewColumn.CellTemplate>
						<DataTemplate>
							<Controls:EditorPresenter>
								<Controls:EditorPresenter.ViewTemplate>
									<ControlTemplate>
										<TextBlock MinWidth="100" Cursor="Hand" Text="{Binding EditingPresentationZone}" Visibility="{Binding IsZoneOrLogic, Converter={StaticResource BoolToVisibilityConverter}}">
											<TextBlock.InputBindings>
												<MouseBinding Command="{Binding ShowZoneOrLogicCommand}" MouseAction="LeftClick" />
											</TextBlock.InputBindings>
											<TextBlock.ToolTip>
												<WrapPanel>
													<TextBlock Text="{Binding EditingPresentationZone}" TextWrapping="Wrap" />
												</WrapPanel>
											</TextBlock.ToolTip>
										</TextBlock>
									</ControlTemplate>
								</Controls:EditorPresenter.ViewTemplate>
							</Controls:EditorPresenter>
						</DataTemplate>
					</GridViewColumn.CellTemplate>
				</GridViewColumn>

				<GridViewColumn Width="100" Header="Примечание">
					<GridViewColumn.CellTemplate>
						<DataTemplate>
							<Controls:EditorPresenter>
								<Controls:EditorPresenter.ViewTemplate>
									<ControlTemplate>
										<TextBlock Text="{Binding Description}" />
									</ControlTemplate>
								</Controls:EditorPresenter.ViewTemplate>
								<Controls:EditorPresenter.EditTemplate>
									<ControlTemplate>
										<TextBox Name="descriptionTextBox" HorizontalAlignment="Stretch" BorderThickness="0" Foreground="Black" Text="{Binding Description, UpdateSourceTrigger=PropertyChanged}" />
										<ControlTemplate.Triggers>
											<Trigger SourceName="descriptionTextBox" Property="IsVisible" Value="True">
												<Setter TargetName="descriptionTextBox" Property="FocusManager.FocusedElement" Value="{Binding ElementName=descriptionTextBox}" />
											</Trigger>
										</ControlTemplate.Triggers>
									</ControlTemplate>
								</Controls:EditorPresenter.EditTemplate>
							</Controls:EditorPresenter>
						</DataTemplate>
					</GridViewColumn.CellTemplate>
				</GridViewColumn>
			</Controls:TreeListView.Columns>
		</Controls:TreeListView>
		<GridSplitter Grid.Row="1" Height="5" HorizontalAlignment="Stretch" VerticalAlignment="Stretch" Background="Transparent" Cursor="SizeNS" />
		<Border Grid.Row="2" Margin="0, 5, 0, 0" Background="{DynamicResource BackgroundBrush}" CornerRadius="5,0,0,5" DataContext="{Binding SelectedDevice}">
			<ScrollViewer VerticalScrollBarVisibility="Auto">
				<StackPanel Margin="5" HorizontalAlignment="Left">
					<StackPanel Orientation="Horizontal">
						<Image Width="16" Margin="2 2 5 2" Source="{Binding Driver.ImageSource}" />
						<TextBlock VerticalAlignment="Center" FontWeight="Bold" Foreground="White" Text="{Binding Driver.Name}" />
					</StackPanel>
					<StackPanel Orientation="Horizontal">
						<TextBlock Margin="2 2 5 2" Foreground="White" Text="Подключено к " />
						<TextBlock VerticalAlignment="Center" FontWeight="Bold" Foreground="White">
							<Hyperlink Command="{Binding ShowParentCommand}" Style="{StaticResource HyperlinkStyle}">
								<TextBlock Margin="2" Text="{Binding Device.Parent.Driver.ShortName}" />
							</Hyperlink>
						</TextBlock>
						<StackPanel.Style>
							<Style>
								<Style.Triggers>
									<DataTrigger Binding="{Binding Device.Parent}" Value="{x:Null}">
										<Setter Property="StackPanel.Visibility" Value="Collapsed" />
									</DataTrigger>
								</Style.Triggers>
							</Style>
						</StackPanel.Style>
					</StackPanel>
					<WrapPanel Orientation="Horizontal" Visibility="{Binding IsZoneOrLogic, Converter={StaticResource BoolToVisibilityConverter}}">
						<Label Content="Зона или Логика: " />
						<Label Content="Зона или Логика не указана" IsEnabled="False">
							<Label.Style>
								<Style>
									<Setter Property="Label.Visibility" Value="Collapsed" />
									<Style.Triggers>
										<DataTrigger Binding="{Binding PresentationZone}" Value="">
											<Setter Property="Label.Visibility" Value="Visible" />
										</DataTrigger>
									</Style.Triggers>
								</Style>
							</Label.Style>
						</Label>
						<TextBlock VerticalAlignment="Center">
							<Hyperlink Command="{Binding ShowZoneCommand}" Style="{StaticResource HyperlinkStyle}">
								<TextBlock Margin="2" Text="{Binding PresentationZone}" TextWrapping="Wrap" />
							</Hyperlink>
							<TextBlock.Style>
								<Style>
									<Style.Triggers>
										<DataTrigger Binding="{Binding PresentationZone}" Value="">
											<Setter Property="TextBlock.Visibility" Value="Collapsed" />
										</DataTrigger>
									</Style.Triggers>
								</Style>
							</TextBlock.Style>
						</TextBlock>
					</WrapPanel>
					<Views:PropertiesView DataContext="{Binding PropertiesViewModel}" />
				</StackPanel>
			</ScrollViewer>
		</Border>
	</Grid>
</UserControl>