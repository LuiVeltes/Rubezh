<UserControl x:Class="GKModule.Views.DevicesView" xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation" xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml" xmlns:Controls="clr-namespace:Controls;assembly=Controls" xmlns:Conv="clr-namespace:Controls.Converters;assembly=Controls" xmlns:Converters="clr-namespace:GKModule.Converters" xmlns:drag="clr-namespace:Infrastructure.Common.Services.DragDrop;assembly=Infrastructure.Common" xmlns:tree="clr-namespace:Controls.TreeList;assembly=Controls" xmlns:Views="clr-namespace:GKModule.Views" xmlns:viewModel="clr-namespace:GKModule.ViewModels">

	<UserControl.Resources>
        <Converters:DeviceParameterMissmatchTypeToColorConverter3 x:Key="DeviceParameterMissmatchTypeToColorConverter3" />
        <Conv:SwitchConverter x:Key="Tooltip" Else="{x:Null}">
			<Conv:SwitchCase Then="Устройство может быть размещено на плане" When="Multiple" />
			<Conv:SwitchCase Then="Устройство не размещено на плане" When="NotPresent" />
			<Conv:SwitchCase Then="Устройство нельзя размещать на плане" When="Prohibit" />
			<Conv:SwitchCase Then="Устройство уже размещено на плане" When="Single" />
		</Conv:SwitchConverter>
		<ContextMenu x:Key="DeviceContextMenu">
            <MenuItem Header="Копировать (Ctrl+C)" Command="{Binding CopyCommand}">
                <MenuItem.Icon>
                    <Image Source="/Controls;component/Images/BCopy.png" Width="16" VerticalAlignment="Center" />
                </MenuItem.Icon>
            </MenuItem>
            <MenuItem Header="Вырезать (Ctrl+Х)" Command="{Binding CutCommand}">
                <MenuItem.Icon>
                    <Image Source="/Controls;component/Images/BCut.png" Width="16" VerticalAlignment="Center" />
                </MenuItem.Icon>
            </MenuItem>
            <MenuItem Header="Вставить (Ctrl+V)" Command="{Binding PasteCommand}">
                <MenuItem.Icon>
                    <Image Source="/Controls;component/Images/BPaste.png" Width="16" VerticalAlignment="Center" />
                </MenuItem.Icon>
            </MenuItem>
            <Separator />
            <MenuItem Header="Добавить дочернее устройство (Ctrl+N)" Command="{Binding AddCommand}">
                <MenuItem.Icon>
                    <Image Source="/Controls;component/Images/BAdd.png" Width="16" VerticalAlignment="Center" />
                </MenuItem.Icon>
            </MenuItem>
            <MenuItem Header="Добавить к родительскому устройству (Ctrl+M)" Command="{Binding AddToParentCommand}">
                <MenuItem.Icon>
                    <Image Source="/Controls;component/Images/BAddChild.png" Width="16" VerticalAlignment="Center" />
                </MenuItem.Icon>
            </MenuItem>
            <MenuItem Header="Удалить (Ctrl+Del)" Command="{Binding RemoveCommand}">
                <MenuItem.Icon>
                    <Image Source="/Controls;component/Images/BDelete.png" Width="16" VerticalAlignment="Center" />
                </MenuItem.Icon>
            </MenuItem>
            <MenuItem Header="Настройка логики исполнительного устройства по состоянию зон" Command="{Binding ShowLogicCommand}">
                <MenuItem.Icon>
                    <Image Source="/Controls;component/Images/BLogic.png" Width="16" VerticalAlignment="Center" />
                </MenuItem.Icon>
            </MenuItem>
            <MenuItem Header="Свойства" Command="{Binding ShowPropertiesCommand}">
                <MenuItem.Icon>
                    <Image Source="/Controls;component/Images/BSettings.png" Width="16" VerticalAlignment="Center" />
                </MenuItem.Icon>
            </MenuItem>
            <Separator Visibility="{Binding Driver.IsPlaceable, Converter={StaticResource BoolToVisibilityConverter}}" />
            <MenuItem Header="Разрешить множественную визуализацию" Command="{Binding AllowMultipleVizualizationCommand}" CommandParameter="{StaticResource True}" Visibility="{Binding Driver.IsPlaceable, Converter={StaticResource BoolToVisibilityConverter}}">
                <MenuItem.Icon>
                    <Image Source="/Controls;component/Images/Eye2.png" Width="16" VerticalAlignment="Center" />
                </MenuItem.Icon>
            </MenuItem>
            <MenuItem Header="Запретить множественную визуализацию" Command="{Binding AllowMultipleVizualizationCommand}" CommandParameter="{StaticResource False}">
                <MenuItem.Icon>
                    <Image Source="/Controls;component/Images/Eye3.png" Width="16" VerticalAlignment="Center" />
                </MenuItem.Icon>
            </MenuItem>
            <MenuItem Header="Параметры">
                <MenuItem.Icon>
                    <Image Source="/Controls;component/Images/BParametersReadWrite.png" Width="16" VerticalAlignment="Center" />
                </MenuItem.Icon>
                <MenuItem Header="Считать параметры" Command="{Binding ReadCommand}">
                    <MenuItem.Icon>
                        <Image Source="/Controls;component/Images/BParametersRead.png" Width="16" VerticalAlignment="Center" />
                    </MenuItem.Icon>
                </MenuItem>
                <MenuItem Header="Считать параметры дочерних устройств" Command="{Binding ReadAllCommand}">
                    <MenuItem.Icon>
                        <Image Source="/Controls;component/Images/BParametersReadAll.png" Width="16" VerticalAlignment="Center" />
                    </MenuItem.Icon>
                </MenuItem>
                <MenuItem Header="Записать параметры" Command="{Binding WriteCommand}">
                    <MenuItem.Icon>
                        <Image Source="/Controls;component/Images/BParametersWrite.png" Width="16" VerticalAlignment="Center" />
                    </MenuItem.Icon>
                </MenuItem>
                <MenuItem Header="Записать параметры дочерних устройств" Command="{Binding WriteAllCommand}">
                    <MenuItem.Icon>
                        <Image Source="/Controls;component/Images/BParametersWriteAll.png" Width="16" VerticalAlignment="Center" />
                    </MenuItem.Icon>
                </MenuItem>
                <Separator />
                <MenuItem Header="Копировать параметры" Command="{Binding CopyParamCommand}">
                    <MenuItem.Icon>
                        <Image Source="/Controls;component/Images/BCopy.png" Width="16" VerticalAlignment="Center" />
                    </MenuItem.Icon>
                </MenuItem>
                <MenuItem Header="Вставить параметры" Command="{Binding PasteParamCommand}">
                    <MenuItem.Icon>
                        <Image Source="/Controls;component/Images/BPaste.png" Width="16" VerticalAlignment="Center" />
                    </MenuItem.Icon>
                </MenuItem>
                <MenuItem Header="Вставить параметры во все дочерние устройства" Command="{Binding PasteAllParamCommand}">
                    <MenuItem.Icon>
                        <Image Source="/Controls;component/Images/BPasteAll.png" Width="16" VerticalAlignment="Center" />
                    </MenuItem.Icon>
                </MenuItem>
                <Separator />
                <MenuItem Header="Применить шаблон" Command="{Binding PasteTemplateCommand}">
                    <MenuItem.Icon>
                        <Image Source="/Controls;component/Images/BBriefcase.png" Width="16" VerticalAlignment="Center" />
                    </MenuItem.Icon>
                </MenuItem>
                <MenuItem Header="Применить шаблон ко всем дочерним устройствам" Command="{Binding PasteAllTemplateCommand}">
                    <MenuItem.Icon>
                        <Image Source="/Controls;component/Images/BBriefcaseAll.png" Width="16" VerticalAlignment="Center" />
                    </MenuItem.Icon>
                </MenuItem>
                <Separator />
                <MenuItem Header="Копировать параметры из устройства в систему" Command="{Binding SyncFromDeviceToSystemCommand}">
                    <MenuItem.Icon>
                        <Image Source="/Controls;component/Images/BLeft.png" Width="16" VerticalAlignment="Center" />
                    </MenuItem.Icon>
                </MenuItem>
                <MenuItem Header="Копировать параметры из всех дочерних устройств в систему" Command="{Binding SyncFromAllDeviceToSystemCommand}">
                    <MenuItem.Icon>
                        <Image Source="/Controls;component/Images/BLeftLeft.png" Width="16" VerticalAlignment="Center" />
                    </MenuItem.Icon>
                </MenuItem>
            </MenuItem>
        </ContextMenu>
		<viewModel:DeviceViewModelDeviceComparer x:Key="DeviceViewModelDeviceComparer" />
		<viewModel:DeviceViewModelAddressComparer x:Key="DeviceViewModelAddressComparer" />
		<viewModel:DeviceViewModelZoneComparer x:Key="DeviceViewModelZoneComparer" />
		<viewModel:DeviceViewModelDescriptionComparer x:Key="DeviceViewModelDescriptionComparer" />
	</UserControl.Resources>

	<Grid>
		<Grid.RowDefinitions>
            <RowDefinition Height="*" MinHeight="200" />
            <RowDefinition Height="Auto" />
            <RowDefinition Height="180" MinHeight="150" MaxHeight="300" />
        </Grid.RowDefinitions>
		<tree:TreeList Grid.Row="0" Focusable="True" SelectedTreeNode="{Binding SelectedDevice}" Source="{Binding RootDevices}" tree:SortBehavior.CanUserSortColumns="False">
			<tree:TreeList.Resources>
				<Style x:Key="{x:Type ComboBox}" BasedOn="{StaticResource {x:Type ComboBox}}" TargetType="ComboBox">
					<Setter Property="MinWidth" Value="0" />
					<Setter Property="MinHeight" Value="0" />
				</Style>
				<Style x:Key="{x:Type TextBox}" BasedOn="{StaticResource {x:Type TextBox}}" TargetType="TextBox">
					<Setter Property="MinWidth" Value="0" />
					<Setter Property="MinHeight" Value="0" />
				</Style>
			</tree:TreeList.Resources>
			<tree:TreeList.View>
				<GridView>
					<GridViewColumn Width="250" Header="Устройство" tree:SortBehavior.SortComparer="{StaticResource DeviceViewModelDeviceComparer}">
						<GridViewColumn.CellTemplate>
							<DataTemplate>
								<DockPanel ContextMenu="{StaticResource DeviceContextMenu}">
									<drag:DragDropDecorator AllowSimulateDrag="True" DragCommand="{Binding CreateDragObjectCommand}" DragVisualProvider="{Binding CreateDragVisual}" DynamicCursor="True" IsSource="True">
										<Image Source="{Binding VisualizationState, Converter={StaticResource VisualizationStateToImageSourceConverter}}" ToolTip="{Binding VisualizationState, Converter={StaticResource Tooltip}}" />
									</drag:DragDropDecorator>
									<Controls:EditorPresenter>
										<Controls:EditorPresenter.ViewTemplate>
											<ControlTemplate>
												<StackPanel Orientation="Horizontal">
													<Image Width="16" Height="16" Margin="5, 0, 5, 0" HorizontalAlignment="Left" Source="{Binding Driver.ImageSource}" />
                                                    <TextBlock Foreground ="{Binding PropertiesViewModel.DeviceParameterMissmatchType, Converter={StaticResource DeviceParameterMissmatchTypeToColorConverter3}}" Width="200" HorizontalAlignment="Left" VerticalAlignment="Center" Text="{Binding Device.ShortName}" />
                                                </StackPanel>
											</ControlTemplate>
										</Controls:EditorPresenter.ViewTemplate>
										<Controls:EditorPresenter.EditTemplate>
											<ControlTemplate>
                                                <StackPanel Orientation="Horizontal">
                                                    <ComboBox ItemsSource="{Binding AvailvableDrivers}" SelectedItem="{Binding Driver, UpdateSourceTrigger=PropertyChanged}" Visibility="{Binding CanChangeDriver, Converter={StaticResource BoolToVisibilityConverter}}">
                                                        <ComboBox.ItemTemplate>
                                                            <DataTemplate>
                                                                <StackPanel Orientation="Horizontal">
                                                                    <Image Width="16" Height="16" Margin="5, 0, 5, 0" HorizontalAlignment="Left" VerticalAlignment="Center" Source="{Binding ImageSource}" />
                                                                    <TextBlock HorizontalAlignment="Left" VerticalAlignment="Center" Foreground="Black" Text="{Binding ShortName}" />
                                                                </StackPanel>
                                                            </DataTemplate>
                                                        </ComboBox.ItemTemplate>
                                                    </ComboBox>
                                                    <Image Width="16" Height="16" Margin="5, 0, 5, 0" HorizontalAlignment="Left" Source="{Binding Driver.ImageSource}"
                                                        Visibility="{Binding CanChangeDriver, Converter={StaticResource InversedBoolToVisibilityConverter}}" />
                                                    <TextBlock HorizontalAlignment="Left" VerticalAlignment="Center" Text="{Binding Device.ShortName}"
                                                        Visibility="{Binding CanChangeDriver, Converter={StaticResource InversedBoolToVisibilityConverter}}" />
                                                </StackPanel>
											</ControlTemplate>
										</Controls:EditorPresenter.EditTemplate>
									</Controls:EditorPresenter>
								</DockPanel>
							</DataTemplate>
						</GridViewColumn.CellTemplate>
					</GridViewColumn>

					<GridViewColumn Width="100" Header="Адрес" tree:SortBehavior.SortComparer="{StaticResource DeviceViewModelAddressComparer}">
						<GridViewColumn.CellTemplate>
							<DataTemplate>
								<Controls:EditorPresenter>
									<Controls:EditorPresenter.ViewTemplate>
										<ControlTemplate>
											<TextBlock Text="{Binding PresentationAddress}" />
										</ControlTemplate>
									</Controls:EditorPresenter.ViewTemplate>
									<Controls:EditorPresenter.EditTemplate>
										<ControlTemplate>
											<Grid>
												<Views:AddressEditor Address="{Binding Address}" Device="{Binding Device}" Visibility="{Binding Device.CanEditAddress, Converter={StaticResource BoolToVisibilityConverter}}" />
												<TextBlock Text="{Binding Address}" Visibility="{Binding Device.CanEditAddress, Converter={StaticResource InversedBoolToVisibilityConverter}}" />
											</Grid> 
										</ControlTemplate>
									</Controls:EditorPresenter.EditTemplate>
								</Controls:EditorPresenter>
							</DataTemplate>
						</GridViewColumn.CellTemplate>
					</GridViewColumn>

					<GridViewColumn Width="300" Header="Зона или Логика" tree:SortBehavior.SortComparer="{StaticResource DeviceViewModelZoneComparer}">
						<GridViewColumn.CellTemplate>
							<DataTemplate>
								<Controls:EditorPresenter>
									<Controls:EditorPresenter.ViewTemplate>
										<ControlTemplate>
											<TextBlock MinWidth="100" Cursor="Hand" Text="{Binding EditingPresentationZone}" Visibility="{Binding IsZoneOrLogic, Converter={StaticResource BoolToVisibilityConverter}}">
                                                <TextBlock.Style>
											        <Style TargetType="TextBlock">
												        <Style.Triggers>
													        <DataTrigger Binding="{Binding IsZoneGrayed}" Value="True">
														        <Setter Property="TextBlock.Foreground" Value="Gray" />
													        </DataTrigger>
												        </Style.Triggers>
											        </Style>
										        </TextBlock.Style>
												<TextBlock.InputBindings>
													<MouseBinding Command="{Binding ShowZoneOrLogicCommand}" MouseAction="LeftClick" />
												</TextBlock.InputBindings>
												<TextBlock.ToolTip>
													<WrapPanel>
														<TextBlock Text="{Binding EditingPresentationZone}" TextWrapping="Wrap" />
													</WrapPanel>
												</TextBlock.ToolTip>
											</TextBlock>
										</ControlTemplate>
									</Controls:EditorPresenter.ViewTemplate>
								</Controls:EditorPresenter>
							</DataTemplate>
						</GridViewColumn.CellTemplate>
					</GridViewColumn>

					<GridViewColumn Width="100" Header="Примечание" tree:SortBehavior.SortComparer="{StaticResource DeviceViewModelDescriptionComparer}">
						<GridViewColumn.CellTemplate>
							<DataTemplate>
								<Controls:EditorPresenter>
									<Controls:EditorPresenter.ViewTemplate>
										<ControlTemplate>
											<TextBlock Text="{Binding Description}" />
										</ControlTemplate>
									</Controls:EditorPresenter.ViewTemplate>
									<Controls:EditorPresenter.EditTemplate>
										<ControlTemplate>
											<TextBox Name="descriptionTextBox" HorizontalAlignment="Stretch" BorderThickness="0" Foreground="Black" Text="{Binding Description, UpdateSourceTrigger=PropertyChanged}" />
											<ControlTemplate.Triggers>
												<Trigger SourceName="descriptionTextBox" Property="IsVisible" Value="True">
													<Setter TargetName="descriptionTextBox" Property="FocusManager.FocusedElement" Value="{Binding ElementName=descriptionTextBox}" />
												</Trigger>
											</ControlTemplate.Triggers>
										</ControlTemplate>
									</Controls:EditorPresenter.EditTemplate>
								</Controls:EditorPresenter>
							</DataTemplate>
						</GridViewColumn.CellTemplate>
					</GridViewColumn>
				</GridView>
			</tree:TreeList.View>
		</tree:TreeList>
		<GridSplitter Grid.Row="1" Height="5" HorizontalAlignment="Stretch" VerticalAlignment="Stretch" Background="Transparent" Cursor="SizeNS" />
		<Border Grid.Row="2" Margin="0, 5, 0, 0" Background="{DynamicResource BackgroundBrush}" CornerRadius="5,0,0,5" DataContext="{Binding SelectedDevice}">
            <Grid>
                <Grid.RowDefinitions>
                    <RowDefinition Height="*" />
                    <RowDefinition Height="Auto" />
                </Grid.RowDefinitions>
                <ScrollViewer Grid.Row="0" VerticalScrollBarVisibility="Auto">
				    <StackPanel Margin="5" HorizontalAlignment="Left">
					    <StackPanel Orientation="Horizontal">
						    <Image Width="16" Margin="2 2 5 2" Source="{Binding Driver.ImageSource}" />
						    <TextBlock VerticalAlignment="Center" FontWeight="Bold" Foreground="White" Text="{Binding Driver.Name}" />
					    </StackPanel>
					    <StackPanel Orientation="Horizontal">
                            <TextBlock Text="Подключено к " Foreground="White" Width="120" Margin="2 2 5 2" />
						    <TextBlock VerticalAlignment="Center" FontWeight="Bold" Foreground="White">
							    <Hyperlink Command="{Binding ShowParentCommand}" Style="{StaticResource HyperlinkStyle}">
                                    <StackPanel Orientation="Horizontal">
                                        <Image Width="16" Margin="2 2 5 2" Source="{Binding Device.Parent.Driver.ImageSource}" />
								        <TextBlock Text="{Binding Device.Parent.PresentationName}" Margin="2" />
                                    </StackPanel>
							    </Hyperlink>
						    </TextBlock>
						    <StackPanel.Style>
							    <Style>
								    <Style.Triggers>
									    <DataTrigger Binding="{Binding Device.Parent}" Value="{x:Null}">
										    <Setter Property="StackPanel.Visibility" Value="Collapsed" />
									    </DataTrigger>
								    </Style.Triggers>
							    </Style>
						    </StackPanel.Style>
					    </StackPanel>
					    <WrapPanel Orientation="Horizontal" Visibility="{Binding IsZoneOrLogic, Converter={StaticResource BoolToVisibilityConverter}}">
                            <TextBlock Text="Зона или Логика " Foreground="White" Width="120" Margin="2 2 5 2" />
                            <TextBlock Text="Зона или Логика не указана" Foreground="White" FontStyle="Italic" Margin="2 2 5 2">
                                <TextBlock.Style>
								    <Style>
                                    <Setter Property="TextBlock.Visibility" Value="Collapsed" />
									    <Style.Triggers>
										    <DataTrigger Binding="{Binding PresentationZone}" Value="">
                                            <Setter Property="TextBlock.Visibility" Value="Visible" />
										    </DataTrigger>
									    </Style.Triggers>
								    </Style>
                                </TextBlock.Style>
                            </TextBlock>
						    <TextBlock VerticalAlignment="Center">
							    <Hyperlink Command="{Binding ShowZoneCommand}" Style="{StaticResource HyperlinkStyle}">
                                    <StackPanel Orientation="Horizontal">
                                        <Image Width="16" Margin="2 2 5 2" Source="/Controls;component/Images/zone.png" />
								        <TextBlock Text="{Binding PresentationZone}" TextWrapping="Wrap" Margin="2" />
                                    </StackPanel>
							    </Hyperlink>
							    <TextBlock.Style>
								    <Style>
									    <Style.Triggers>
										    <DataTrigger Binding="{Binding PresentationZone}" Value="">
											    <Setter Property="TextBlock.Visibility" Value="Collapsed" />
										    </DataTrigger>
									    </Style.Triggers>
								    </Style>
							    </TextBlock.Style>
						    </TextBlock>
					    </WrapPanel>
					    <Views:PropertiesView DataContext="{Binding PropertiesViewModel}" />
				    </StackPanel>
			    </ScrollViewer>
                <Grid Grid.Row="1">
                    <StackPanel Orientation="Horizontal" HorizontalAlignment="Right">
                        <Controls:ToolBarButton Command="{Binding SyncFromAllDeviceToSystemCommand}" ToolTip="Заменить все значения параметров системы на значения параметров в устройстве" ImageSource="/Controls;component/Images/LeftLeft.png" />
                        <Controls:ToolBarButton Command="{Binding SyncFromDeviceToSystemCommand}" ToolTip="Заменить значения параметров системы на значения параметров в устройстве" ImageSource="/Controls;component/Images/Left.png" />
                        <Controls:ToolBarButton Command="{Binding ReadCommand}" ToolTip="Считать параметры" ImageSource="/Controls;component/Images/ParametersRead.png" />
                        <Controls:ToolBarButton Command="{Binding WriteCommand}" ToolTip="Записать параметры" ImageSource="/Controls;component/Images/ParametersWrite.png" />
                        <Controls:ToolBarButton Command="{Binding ReadAllCommand}" ToolTip="Считать параметры дочерних устройств" ImageSource="/Controls;component/Images/ParametersReadAll.png" />
                        <Controls:ToolBarButton Command="{Binding WriteAllCommand}" ToolTip="Записать параметры дочерних устройств" ImageSource="/Controls;component/Images/ParametersWriteAll.png" />
                        <Controls:ToolBarButton Command="{Binding CopyParamCommand}" ToolTip="Копировать параметры" ImageSource="/Controls;component/Images/Copy.png" />
                        <Controls:ToolBarButton Command="{Binding PasteParamCommand}" ToolTip="Вставить параметры" ImageSource="/Controls;component/Images/Paste.png" />
                        <Controls:ToolBarButton Command="{Binding PasteAllParamCommand}" ToolTip = "Вставить параметры во все дочерние устройства" ImageSource = "/Controls;component/Images/PasteAll.png" />
                    </StackPanel>
                </Grid>
            </Grid>
        </Border>
	</Grid>
</UserControl>